{% extends "admin/base.html" %}

{% block title %}Usuarios{% endblock %}
{% block page_title %}Gerenciar Usu√°rios{% endblock %}

{% block content %}
<div class="page-header">
    <button class="btn btn-primary" onclick="openCreateModal()">
        <i class="fas fa-plus"></i> Novo Usuario
    </button>
</div>

<div class="table-container">
    <table class="data-table">
        <thead>
            <tr>
                <th>ID</th>
                <th>Nome</th>
                <th>Email</th>
                <th>Administrador</th>
                <th>13HP</th>
                <th>Ativo</th>
                <th>Ultimo Login</th>
                <th>Criado em</th>
                <th>Acoes</th>
            </tr>
        </thead>
        <tbody>
            {% for user in users %}
            <tr data-id="{{ user.id }}">
                <td>{{ user.id }}</td>
                <td>{{ user.name }}</td>
                <td>{{ user.email }}</td>
                <td>
                    {% if user.is_admin %}
                    <span class="badge badge-success"><i class="fas fa-check"></i> Sim</span>
                    {% else %}
                    <span class="badge badge-secondary"><i class="fas fa-times"></i> Nao</span>
                    {% endif %}
                </td>
                <td>
                    {% if user.has_13hp_permission %}
                    <span class="badge badge-success"><i class="fas fa-tachometer-alt"></i> Sim</span>
                    {% elif user.interested_in_13hp %}
                    <span class="badge badge-warning"><i class="fas fa-clock"></i> Interessado</span>
                    {% else %}
                    <span class="badge badge-secondary"><i class="fas fa-times"></i> Nao</span>
                    {% endif %}
                </td>
                <td>
                    {% if user.is_active %}
                    <span class="badge badge-success"><i class="fas fa-check-circle"></i> Ativo</span>
                    {% else %}
                    <span class="badge badge-danger"><i class="fas fa-ban"></i> Inativo</span>
                    {% endif %}
                </td>
                <td>{{ user.last_login.strftime('%d/%m/%Y %H:%M') if user.last_login else '-' }}</td>
                <td>{{ user.created_at.strftime('%d/%m/%Y') if user.created_at else '-' }}</td>
                <td class="actions">
                    <button class="btn btn-sm btn-secondary" onclick='openEditModal({{ user.id }}, {{ user.to_dict()|tojson }})'>
                        <i class="fas fa-edit"></i>
                    </button>
                    {% if user.id != current_user.id %}
                    <button class="btn btn-sm btn-danger" onclick="confirmDelete({{ user.id }}, '{{ user.name }}')">
                        <i class="fas fa-trash"></i>
                    </button>
                    {% else %}
                    <button class="btn btn-sm btn-danger" disabled title="Voce nao pode excluir sua propria conta">
                        <i class="fas fa-ban"></i>
                    </button>
                    {% endif %}
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="9" class="empty-message">Nenhum usuario cadastrado</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Create/Edit Form Template -->
<template id="user-form-template">
    <form id="user-form" onsubmit="saveUser(event)">
        <input type="hidden" id="user-id" name="id">
        <div class="form-group">
            <label for="user-name">Nome *</label>
            <input type="text" id="user-name" name="name" required>
        </div>
        <div class="form-group">
            <label for="user-email">Email *</label>
            <input type="email" id="user-email" name="email" required>
        </div>
        <div class="form-group">
            <label for="user-password">Senha <span id="password-hint">(deixe em branco para manter a atual)</span></label>
            <input type="password" id="user-password" name="password" minlength="6">
            <small class="form-hint">Minimo 6 caracteres</small>
        </div>
        <div class="form-group">
            <label class="checkbox-label">
                <input type="checkbox" id="user-admin" name="is_admin" value="true">
                <span>Administrador</span>
            </label>
            <small class="form-hint">Administradores tem acesso total ao sistema</small>
        </div>
        <div class="form-group">
            <label class="checkbox-label">
                <input type="checkbox" id="user-active" name="is_active" value="true" checked>
                <span>Usuario Ativo</span>
            </label>
            <small class="form-hint">Usuarios inativos nao podem fazer login</small>
        </div>
        <div class="form-group">
            <label class="checkbox-label">
                <input type="checkbox" id="user-13hp" name="has_13hp_permission" value="true">
                <span>Permissao 13HP</span>
            </label>
            <small class="form-hint">Conceder permissao para pilotar karts de 13HP</small>
        </div>
        <div class="modal-actions">
            <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
            <button type="submit" class="btn btn-primary">Salvar</button>
        </div>
    </form>
</template>

{% endblock %}

{% block scripts %}
<script>
const entityUrl = '/admin/users';

function openCreateModal() {
    document.getElementById('modal-title').textContent = 'Novo Usuario';
    const template = document.getElementById('user-form-template');
    document.getElementById('modal-body').innerHTML = template.innerHTML;

    // Clear form and set defaults
    document.getElementById('user-id').value = '';
    document.getElementById('user-password').required = true;
    document.getElementById('password-hint').textContent = '';

    openModal();
}

function openEditModal(id, user) {
    document.getElementById('modal-title').textContent = 'Editar Usuario';
    const template = document.getElementById('user-form-template');
    document.getElementById('modal-body').innerHTML = template.innerHTML;

    // Populate form
    document.getElementById('user-id').value = id;
    document.getElementById('user-name').value = user.name || '';
    document.getElementById('user-email').value = user.email || '';
    document.getElementById('user-password').required = false;
    document.getElementById('user-admin').checked = user.is_admin || false;
    document.getElementById('user-active').checked = user.is_active !== false;
    document.getElementById('user-13hp').checked = user.has_13hp_permission || false;

    // Prevent user from removing their own admin status
    if (id === {{ current_user.id }}) {
        document.getElementById('user-admin').disabled = true;
        const hint = document.createElement('small');
        hint.className = 'form-hint warning';
        hint.textContent = 'Voce nao pode remover seu proprio status de administrador';
        document.getElementById('user-admin').parentElement.appendChild(hint);
    }

    openModal();
}

function saveUser(event) {
    event.preventDefault();
    const form = document.getElementById('user-form');
    const id = document.getElementById('user-id').value;
    const formData = new FormData(form);

    // Convert checkbox values
    const data = {
        name: formData.get('name'),
        email: formData.get('email'),
        is_admin: formData.get('is_admin') === 'true',
        is_active: formData.get('is_active') === 'true',
        has_13hp_permission: formData.get('has_13hp_permission') === 'true'
    };

    // Only include password if it's filled
    const password = formData.get('password');
    if (password) {
        data.password = password;
    }

    const method = id ? 'PUT' : 'POST';
    const url = id ? `${entityUrl}/${id}` : entityUrl;

    fetch(url, {
        method: method,
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showNotification(result.message, 'success');
            closeModal();
            setTimeout(() => location.reload(), 500);
        } else {
            showNotification(result.message, 'error');
        }
    })
    .catch(error => {
        showNotification('Erro ao salvar usuario', 'error');
        console.error(error);
    });
}

function confirmDelete(id, name) {
    document.getElementById('delete-message').textContent = `Tem certeza que deseja excluir o usuario "${name}"?`;
    document.getElementById('confirm-delete-btn').onclick = () => deleteUser(id);
    openDeleteModal();
}

function deleteUser(id) {
    fetch(`${entityUrl}/${id}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showNotification(result.message, 'success');
            closeDeleteModal();
            setTimeout(() => location.reload(), 500);
        } else {
            showNotification(result.message, 'error');
        }
    })
    .catch(error => {
        showNotification('Erro ao excluir usuario', 'error');
        console.error(error);
    });
}
</script>
{% endblock %}
